workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
      when: never
    - when: always

image: python:3.10-slim
default:
  tags:
    - br100

stages:
    - test
    - report
    
run_test:
    stage: test
    image: python
    artifacts:
      when: always
      expire_in: 5 days
      paths:
          - backend/tests/allure-report
    before_script:
        - apt-get update
        - apt install -y openjdk-17-jdk openjdk-17-jre
        - wget https://github.com/allure-framework/allure2/releases/download/2.30.0/allure-2.30.0.tgz && tar -zxvf allure-2.30.0.tgz -C /opt/ && ln -s /opt/allure-2.30.0/bin/allure /usr/bin/allure
        - pip install --upgrade pip
        - pip install -r backend/requirements.txt
    script:
        - cd backend/tests
        - pytest -v test_commands_show.py --alluredir=allure-results
        # - allure generate -c allure-results -o allure-report
    after_script:
        - allure generate -c allure-results -o allure-report
pages:
  stage: report
  needs:
    - run_test
  script:
    - mkdir public
    - cp -r allure-report/* public
  artifacts:
    when: on_success
    expire_in: never
    paths:
        - public